import{_ as i,c as a,o as t,aj as n}from"./chunks/framework.CSCBGoZg.js";const g=JSON.parse('{"title":"27. Vectorization and Automatic Differentiation","description":"","frontmatter":{},"headers":[],"relativePath":"specs/27_Vectorization_and_Autograd.md","filePath":"specs/27_Vectorization_and_Autograd.md"}'),e={name:"specs/27_Vectorization_and_Autograd.md"};function h(l,s,k,d,p,r){return t(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="_27-vectorization-and-automatic-differentiation" tabindex="-1">27. Vectorization and Automatic Differentiation <a class="header-anchor" href="#_27-vectorization-and-automatic-differentiation" aria-label="Permalink to “27. Vectorization and Automatic Differentiation”">​</a></h1><p><strong>Version:</strong> 0.1.2<br><strong>Status:</strong> Implemented</p><p>This document specifies Vex&#39;s automatic vectorization, SIMD intrinsics, GPU offloading, and forward-mode automatic differentiation (Autograd) capabilities.</p><hr><h2 id="_27-1-design-philosophy" tabindex="-1">27.1 Design Philosophy <a class="header-anchor" href="#_27-1-design-philosophy" aria-label="Permalink to “27.1 Design Philosophy”">​</a></h2><p>Vex provides vectorization without explicit SIMD types:</p><ul><li><strong>No <code>simd&lt;T&gt;</code> types</strong> - Standard arrays <code>[T]</code> are automatically vectorized</li><li><strong>No <code>#pragma</code> annotations</strong> - The compiler detects opportunities</li><li><strong>Transparent GPU offload</strong> - High-cost operations dispatch to GPU automatically</li><li><strong>First-class Autograd</strong> - Gradient computation with the <code>@</code> operator</li></ul><hr><h2 id="_27-2-simd-operators" tabindex="-1">27.2 SIMD Operators <a class="header-anchor" href="#_27-2-simd-operators" aria-label="Permalink to “27.2 SIMD Operators”">​</a></h2><h3 id="_27-2-1-bitwise-rotation" tabindex="-1">27.2.1 Bitwise Rotation <a class="header-anchor" href="#_27-2-1-bitwise-rotation" aria-label="Permalink to “27.2.1 Bitwise Rotation”">​</a></h3><div class="language-rust"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> i32</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0b1010</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> left </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Rotate left: 0b101000 (with wrap)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> right </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Rotate right: 0b0101 (with wrap)</span></span></code></pre></div><table tabindex="0"><thead><tr><th>Operator</th><th>Name</th><th>CPU Intrinsic</th><th>GPU Fallback</th></tr></thead><tbody><tr><td><code>&lt;&lt;&lt;</code></td><td>Rotate Left</td><td><code>llvm.fshl.i32</code></td><td><code>(a &lt;&lt; n) | (a &gt;&gt; (32-n))</code></td></tr><tr><td><code>&gt;&gt;&gt;</code></td><td>Rotate Right</td><td><code>llvm.fshr.i32</code></td><td><code>(a &gt;&gt; n) | (a &lt;&lt; (32-n))</code></td></tr></tbody></table><h3 id="_27-2-2-fused-multiply-add" tabindex="-1">27.2.2 Fused Multiply-Add <a class="header-anchor" href="#_27-2-2-fused-multiply-add" aria-label="Permalink to “27.2.2 Fused Multiply-Add”">​</a></h3><div class="language-rust"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Only meaningful with accumulator context</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Typical usage in loops:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">..</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">n {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    sum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> arr[i];  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// sum = sum * factor + arr[i]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><table tabindex="0"><thead><tr><th>Operator</th><th>Name</th><th>CPU Intrinsic</th><th>GPU (GLSL)</th></tr></thead><tbody><tr><td><code>*+</code></td><td>Fused Multiply-Add</td><td><code>llvm.fmuladd.*</code></td><td><code>GLSLstd450Fma</code> (50)</td></tr></tbody></table><h3 id="_27-2-3-min-max-operations" tabindex="-1">27.2.3 Min/Max Operations <a class="header-anchor" href="#_27-2-3-min-max-operations" aria-label="Permalink to “27.2.3 Min/Max Operations”">​</a></h3><div class="language-rust"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> minimum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a &lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// min(a, b)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> maximum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a &gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// max(a, b)</span></span></code></pre></div><table tabindex="0"><thead><tr><th>Operator</th><th>Name</th><th>CPU Intrinsic (Int)</th><th>CPU Intrinsic (Float)</th><th>GPU (GLSL)</th></tr></thead><tbody><tr><td><code>&lt;?</code></td><td>Minimum</td><td><code>llvm.smin.i32</code></td><td><code>llvm.minnum.f64</code></td><td><code>GLSLstd450SMin/FMin</code></td></tr><tr><td><code>&gt;?</code></td><td>Maximum</td><td><code>llvm.smax.i32</code></td><td><code>llvm.maxnum.f64</code></td><td><code>GLSLstd450SMax/FMax</code></td></tr></tbody></table><h3 id="_27-2-4-saturating-arithmetic" tabindex="-1">27.2.4 Saturating Arithmetic <a class="header-anchor" href="#_27-2-4-saturating-arithmetic" aria-label="Permalink to “27.2.4 Saturating Arithmetic”">​</a></h3><div class="language-rust"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> safe_add </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Saturates at MAX_INT instead of overflow</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> safe_sub </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Saturates at MIN_INT instead of underflow</span></span></code></pre></div><table tabindex="0"><thead><tr><th>Operator</th><th>Name</th><th>CPU Intrinsic</th></tr></thead><tbody><tr><td><code>+|</code></td><td>Saturating Add</td><td><code>llvm.sadd.sat.i32</code> / <code>llvm.uadd.sat.i32</code></td></tr><tr><td><code>-|</code></td><td>Saturating Sub</td><td><code>llvm.ssub.sat.i32</code> / <code>llvm.usub.sat.i32</code></td></tr></tbody></table><h3 id="_27-2-5-carry-less-multiplication" tabindex="-1">27.2.5 Carry-less Multiplication <a class="header-anchor" href="#_27-2-5-carry-less-multiplication" aria-label="Permalink to “27.2.5 Carry-less Multiplication”">​</a></h3><div class="language-rust"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> clmul_result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*^</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// For cryptographic operations (CRC, GCM)</span></span></code></pre></div><table tabindex="0"><thead><tr><th>Operator</th><th>Name</th><th>CPU Intrinsic</th></tr></thead><tbody><tr><td><code>*^</code></td><td>Carry-less Mul</td><td><code>llvm.x86.pclmulqdq</code> / <code>llvm.aarch64.crypto.pmull.p64</code></td></tr></tbody></table><hr><h2 id="_27-3-reduction-operators" tabindex="-1">27.3 Reduction Operators <a class="header-anchor" href="#_27-3-reduction-operators" aria-label="Permalink to “27.3 Reduction Operators”">​</a></h2><p>Prefix reduction operators fold arrays:</p><div class="language-rust"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> arr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> arr;      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 15 (sum reduction)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> product </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> arr;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 120 (product reduction)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> min_val </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> arr; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 1 (minimum reduction)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> max_val </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> arr; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 5 (maximum reduction)</span></span></code></pre></div><table tabindex="0"><thead><tr><th>Operator</th><th>Name</th><th>Result</th></tr></thead><tbody><tr><td><code>+|</code> (prefix)</td><td>Sum Reduce</td><td>Σ elements</td></tr><tr><td><code>*|</code> (prefix)</td><td>Product Reduce</td><td>Π elements</td></tr><tr><td><code>&lt;?|</code></td><td>Min Reduce</td><td>min(elements)</td></tr><tr><td><code>&gt;?|</code></td><td>Max Reduce</td><td>max(elements)</td></tr></tbody></table><hr><h2 id="_27-4-matrix-operators" tabindex="-1">27.4 Matrix Operators <a class="header-anchor" href="#_27-4-matrix-operators" aria-label="Permalink to “27.4 Matrix Operators”">​</a></h2><div class="language-rust"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> C</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> A</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">B</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Matrix multiplication: C = A × B</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> A</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &lt;\\&gt; b;      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Solve Ax = b for x</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> A_pow</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> A</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">^</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Matrix power: A³</span></span></code></pre></div><table tabindex="0"><thead><tr><th>Operator</th><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>&lt;*&gt;</code></td><td>Matrix Multiply</td><td>Standard matrix multiplication</td></tr><tr><td><code>&lt;\\&gt;</code></td><td>Matrix Solve</td><td>Linear system solver (Ax = b)</td></tr><tr><td><code>&lt;^&gt;</code></td><td>Matrix Power</td><td>Repeated matrix multiplication</td></tr></tbody></table><hr><h2 id="_27-5-automatic-loop-vectorization" tabindex="-1">27.5 Automatic Loop Vectorization <a class="header-anchor" href="#_27-5-automatic-loop-vectorization" aria-label="Permalink to “27.5 Automatic Loop Vectorization”">​</a></h2><p>Vex automatically vectorizes canonical loops:</p><div class="language-rust"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vector_add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(a</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">f32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], b</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">f32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], c</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">f32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> i32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">..</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">n {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        c[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b[i];  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Vectorized to &lt;4 x float&gt; or &lt;8 x float&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_27-5-1-vectorization-conditions" tabindex="-1">27.5.1 Vectorization Conditions <a class="header-anchor" href="#_27-5-1-vectorization-conditions" aria-label="Permalink to “27.5.1 Vectorization Conditions”">​</a></h3><p>A loop is vectorized when:</p><ol><li><strong>Canonical form</strong>: <code>for i in 0..N</code> pattern</li><li><strong>No side effects</strong>: Body contains only array operations</li><li><strong>No dependencies</strong>: Iterations are independent</li><li><strong>Profitable</strong>: Trip count × operation cost exceeds threshold</li></ol><h3 id="_27-5-2-llvm-metadata" tabindex="-1">27.5.2 LLVM Metadata <a class="header-anchor" href="#_27-5-2-llvm-metadata" aria-label="Permalink to “27.5.2 LLVM Metadata”">​</a></h3><p>The compiler emits loop hints:</p><div class="language-txt"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>!llvm.loop !{!&quot;llvm.loop.vectorize.enable&quot;, i1 true}</span></span>
<span class="line"><span>!llvm.loop !{!&quot;llvm.loop.vectorize.width&quot;, i32 4}</span></span></code></pre></div><h3 id="_27-5-3-scalar-vector-broadcasting" tabindex="-1">27.5.3 Scalar-Vector Broadcasting <a class="header-anchor" href="#_27-5-3-scalar-vector-broadcasting" aria-label="Permalink to “27.5.3 Scalar-Vector Broadcasting”">​</a></h3><div class="language-rust"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> arr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> scaled </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> arr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Broadcasts 2.0 to &lt;4 x float&gt;</span></span></code></pre></div><hr><h2 id="_27-6-gpu-offloading" tabindex="-1">27.6 GPU Offloading <a class="header-anchor" href="#_27-6-gpu-offloading" aria-label="Permalink to “27.6 GPU Offloading”">​</a></h2><h3 id="_27-6-1-implicit-detection" tabindex="-1">27.6.1 Implicit Detection <a class="header-anchor" href="#_27-6-1-implicit-detection" aria-label="Permalink to “27.6.1 Implicit Detection”">​</a></h3><p>The compiler analyzes:</p><ul><li><strong>Arithmetic Intensity</strong>: Compute ops / Memory ops ratio</li><li><strong>Data Independence</strong>: All iterations parallelizable</li><li><strong>Cost Threshold</strong>: Compile-time profitability analysis</li></ul><h3 id="_27-6-2-runtime-dispatch" tabindex="-1">27.6.2 Runtime Dispatch <a class="header-anchor" href="#_27-6-2-runtime-dispatch" aria-label="Permalink to “27.6.2 Runtime Dispatch”">​</a></h3><div class="language-rust"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// With --gpu flag</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">~</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cargo</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">target</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">debug</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vex run program</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">--</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gpu</span></span></code></pre></div><p>When enabled:</p><ol><li>High-cost loops generate SPIR-V kernels</li><li>Runtime checks GPU availability</li><li>Automatic buffer management (CPU ↔ GPU)</li><li>Fallback to CPU SIMD if GPU unavailable</li></ol><h3 id="_27-6-3-spir-v-backend" tabindex="-1">27.6.3 SPIR-V Backend <a class="header-anchor" href="#_27-6-3-spir-v-backend" aria-label="Permalink to “27.6.3 SPIR-V Backend”">​</a></h3><table tabindex="0"><thead><tr><th>Vex Type</th><th>SPIR-V Type</th></tr></thead><tbody><tr><td><code>i32</code></td><td><code>OpTypeInt 32 1</code></td></tr><tr><td><code>u32</code></td><td><code>OpTypeInt 32 0</code></td></tr><tr><td><code>f32</code></td><td><code>OpTypeFloat 32</code></td></tr><tr><td><code>f64</code></td><td><code>OpTypeFloat 64</code></td></tr><tr><td><code>Dual&lt;f64&gt;</code></td><td><code>OpTypeStruct {f64, f64}</code></td></tr><tr><td><code>[T; N]</code></td><td><code>OpTypeRuntimeArray T</code></td></tr></tbody></table><p><strong>Note:</strong> macOS targets use <strong>Metal Shading Language (MSL)</strong> backend automatically (<code>vex-codegen-metal</code>).</p><hr><h2 id="_27-7-automatic-differentiation-autograd" tabindex="-1">27.7 Automatic Differentiation (Autograd) <a class="header-anchor" href="#_27-7-automatic-differentiation-autograd" aria-label="Permalink to “27.7 Automatic Differentiation (Autograd)”">​</a></h2><p>Vex implements <strong>Forward Mode AD</strong> using dual numbers.</p><h3 id="_27-7-1-the-operator" tabindex="-1">27.7.1 The <code>@</code> Operator <a class="header-anchor" href="#_27-7-1-the-operator" aria-label="Permalink to “27.7.1 The @ Operator”">​</a></h3><div class="language-rust"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> i32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> @</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">param(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// x = 3.0, dx = 1.0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2.0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1.0</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // f(x) = x² + 2x + 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;f(3) = &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">$</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">val</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result));   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 16</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;f&#39;(3) = &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">$</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">grad</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result)); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 8 (derivative: 2x + 2)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_27-7-2-dual-number-representation" tabindex="-1">27.7.2 Dual Number Representation <a class="header-anchor" href="#_27-7-2-dual-number-representation" aria-label="Permalink to “27.7.2 Dual Number Representation”">​</a></h3><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>Dual&lt;T&gt; = { val: T, grad: T }</span></span></code></pre></div><table tabindex="0"><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>val</code></td><td>Primal value f(x)</td></tr><tr><td><code>grad</code></td><td>Derivative f&#39;(x)</td></tr></tbody></table><h3 id="_27-7-3-autograd-intrinsics" tabindex="-1">27.7.3 Autograd Intrinsics <a class="header-anchor" href="#_27-7-3-autograd-intrinsics" aria-label="Permalink to “27.7.3 Autograd Intrinsics”">​</a></h3><table tabindex="0"><thead><tr><th>Intrinsic</th><th>Signature</th><th>Description</th></tr></thead><tbody><tr><td><code>$param(x)</code></td><td><code>f64 → Dual&lt;f64&gt;</code></td><td>Create tracked parameter (gradient = 1.0)</td></tr><tr><td><code>$val(d)</code></td><td><code>Dual&lt;T&gt; → T</code></td><td>Extract primal value</td></tr><tr><td><code>$grad(d)</code></td><td><code>Dual&lt;T&gt; → T</code></td><td>Extract gradient</td></tr></tbody></table><h3 id="_27-7-4-supported-operations" tabindex="-1">27.7.4 Supported Operations <a class="header-anchor" href="#_27-7-4-supported-operations" aria-label="Permalink to “27.7.4 Supported Operations”">​</a></h3><h4 id="binary-operations" tabindex="-1">Binary Operations <a class="header-anchor" href="#binary-operations" aria-label="Permalink to “Binary Operations”">​</a></h4><table tabindex="0"><thead><tr><th>Operation</th><th>Forward Rule</th></tr></thead><tbody><tr><td><code>a + b</code></td><td><code>(a.val + b.val, a.grad + b.grad)</code></td></tr><tr><td><code>a - b</code></td><td><code>(a.val - b.val, a.grad - b.grad)</code></td></tr><tr><td><code>a * b</code></td><td><code>(a.val * b.val, a.grad * b.val + a.val * b.grad)</code></td></tr><tr><td><code>a / b</code></td><td><code>(a.val / b.val, (a.grad * b.val - a.val * b.grad) / b.val²)</code></td></tr></tbody></table><h4 id="unary-functions" tabindex="-1">Unary Functions <a class="header-anchor" href="#unary-functions" aria-label="Permalink to “Unary Functions”">​</a></h4><table tabindex="0"><thead><tr><th>Function</th><th>Derivative</th><th>CPU Intrinsic</th><th>GPU (GLSL)</th></tr></thead><tbody><tr><td><code>$sin(x)</code></td><td><code>cos(x) · x&#39;</code></td><td><code>llvm.sin.f64</code></td><td><code>GLSLstd450Sin</code> (13)</td></tr><tr><td><code>$cos(x)</code></td><td><code>-sin(x) · x&#39;</code></td><td><code>llvm.cos.f64</code></td><td><code>GLSLstd450Cos</code> (14)</td></tr><tr><td><code>$tan(x)</code></td><td><code>sec²(x) · x&#39;</code></td><td><code>tan</code></td><td><code>GLSLstd450Tan</code> (15)</td></tr><tr><td><code>$exp(x)</code></td><td><code>exp(x) · x&#39;</code></td><td><code>llvm.exp.f64</code></td><td><code>GLSLstd450Exp</code> (27)</td></tr><tr><td><code>$log(x)</code></td><td><code>(1/x) · x&#39;</code></td><td><code>llvm.log.f64</code></td><td><code>GLSLstd450Log</code> (28)</td></tr><tr><td><code>$sqrt(x)</code></td><td><code>1/(2√x) · x&#39;</code></td><td><code>llvm.sqrt.f64</code></td><td><code>GLSLstd450Sqrt</code> (31)</td></tr><tr><td><code>$asin(x)</code></td><td><code>1/√(1-x²) · x&#39;</code></td><td><code>asin</code></td><td><code>GLSLstd450Asin</code> (16)</td></tr><tr><td><code>$acos(x)</code></td><td><code>-1/√(1-x²) · x&#39;</code></td><td><code>acos</code></td><td><code>GLSLstd450Acos</code> (17)</td></tr><tr><td><code>$atan(x)</code></td><td><code>1/(1+x²) · x&#39;</code></td><td><code>atan</code></td><td><code>GLSLstd450Atan</code> (18)</td></tr><tr><td><code>$abs(x)</code></td><td><code>sign(x) · x&#39;</code></td><td><code>llvm.fabs.f64</code></td><td><code>GLSLstd450FAbs</code> (4)</td></tr><tr><td><code>$pow(x,n)</code></td><td><code>n·xⁿ⁻¹ · x&#39;</code></td><td><code>llvm.pow.f64</code></td><td><code>GLSLstd450Pow</code> (26)</td></tr></tbody></table><h3 id="_27-7-5-gpu-autograd" tabindex="-1">27.7.5 GPU Autograd <a class="header-anchor" href="#_27-7-5-gpu-autograd" aria-label="Permalink to “27.7.5 GPU Autograd”">​</a></h3><p>Autograd works identically on GPU:</p><ul><li><code>Type::Dual&lt;T&gt;</code> maps to SPIR-V struct <code>{T, T}</code></li><li>All binary ops and 11 unary functions supported</li><li>Chain rule computed inline in SPIR-V</li></ul><div class="language-rust"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// GPU-accelerated gradient computation</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> gpu_gradient_kernel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(inputs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">f64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], grads</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">f64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> i32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">..</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">n {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> @</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">param(inputs[i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> u64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sin(x) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">exp(x)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        grads[i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> u64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">grad(result);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h2 id="_27-8-performance-characteristics" tabindex="-1">27.8 Performance Characteristics <a class="header-anchor" href="#_27-8-performance-characteristics" aria-label="Permalink to “27.8 Performance Characteristics”">​</a></h2><h3 id="_27-8-1-cpu-simd-width" tabindex="-1">27.8.1 CPU SIMD Width <a class="header-anchor" href="#_27-8-1-cpu-simd-width" aria-label="Permalink to “27.8.1 CPU SIMD Width”">​</a></h3><table tabindex="0"><thead><tr><th>Architecture</th><th>Integer Width</th><th>Float Width</th></tr></thead><tbody><tr><td>SSE/SSE2</td><td>4 × i32</td><td>4 × f32</td></tr><tr><td>AVX/AVX2</td><td>8 × i32</td><td>8 × f32</td></tr><tr><td>AVX-512</td><td>16 × i32</td><td>16 × f32</td></tr><tr><td>NEON (ARM)</td><td>4 × i32</td><td>4 × f32</td></tr></tbody></table><h3 id="_27-8-2-gpu-dispatch-threshold" tabindex="-1">27.8.2 GPU Dispatch Threshold <a class="header-anchor" href="#_27-8-2-gpu-dispatch-threshold" aria-label="Permalink to “27.8.2 GPU Dispatch Threshold”">​</a></h3><p>A loop is dispatched to GPU when:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>cost = complexity × size × ratio &gt; GPU_THRESHOLD</span></span></code></pre></div><p>Where:</p><ul><li><code>complexity</code> = operation weight (1 for add, 10 for div, 100 for transcendental)</li><li><code>size</code> = number of elements</li><li><code>ratio</code> = compute/memory ratio</li><li><code>GPU_THRESHOLD</code> = platform-specific constant</li></ul><hr><h2 id="_27-9-examples" tabindex="-1">27.9 Examples <a class="header-anchor" href="#_27-9-examples" aria-label="Permalink to “27.9 Examples”">​</a></h2><h3 id="_27-9-1-simd-operations" tabindex="-1">27.9.1 SIMD Operations <a class="header-anchor" href="#_27-9-1-simd-operations" aria-label="Permalink to “27.9.1 SIMD Operations”">​</a></h3><div class="language-rust"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> simd_demo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> i32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> i32</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 42</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> i32</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Bitwise rotation</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rotl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rotr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Min/Max</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> min_val </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a &lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 7</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> max_val </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a &gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 42</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Saturating arithmetic</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> safe </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2000000000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2000000000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// i32.MAX, not overflow</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_27-9-2-autograd-example" tabindex="-1">27.9.2 Autograd Example <a class="header-anchor" href="#_27-9-2-autograd-example" aria-label="Permalink to “27.9.2 Autograd Example”">​</a></h3><div class="language-rust"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> gradient_descent_step</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> f64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, learning_rate</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> f64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> f64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> @</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">param(x);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Loss function: (p - 5)²</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> diff </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        diff </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> diff</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> loss </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">val(result);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gradient </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">grad(result);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Update: x = x - lr * gradient</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> learning_rate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gradient;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> i32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">..</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> gradient_descent_step</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x, lr);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Converged to x = &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, x);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ~5.0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h2 id="_27-10-implementation-files" tabindex="-1">27.10 Implementation Files <a class="header-anchor" href="#_27-10-implementation-files" aria-label="Permalink to “27.10 Implementation Files”">​</a></h2><table tabindex="0"><thead><tr><th>Component</th><th>File</th></tr></thead><tbody><tr><td>SIMD Operators (CPU)</td><td><code>vex-compiler/src/codegen_ast/expressions/binary_ops/vector_ops.rs</code></td></tr><tr><td>Autograd (CPU)</td><td><code>vex-compiler/src/codegen_ast/expressions/special/grad.rs</code></td></tr><tr><td>SPIR-V Types</td><td><code>vex-codegen-spirv/src/types.rs</code></td></tr><tr><td>SPIR-V Operations</td><td><code>vex-codegen-spirv/src/ops.rs</code></td></tr><tr><td>GPU Runtime</td><td><code>vex-runtime-gpu/src/lib.rs</code></td></tr></tbody></table><hr><h2 id="_27-11-masked-vector-operations" tabindex="-1">27.11 Masked Vector Operations <a class="header-anchor" href="#_27-11-masked-vector-operations" aria-label="Permalink to “27.11 Masked Vector Operations”">​</a></h2><p>Vex supports predicated (masked) vector operations for conditional lane execution.</p><h3 id="_27-11-1-vector-select-blend" tabindex="-1">27.11.1 Vector Select (Blend) <a class="header-anchor" href="#_27-11-1-vector-select-blend" aria-label="Permalink to “27.11.1 Vector Select (Blend)”">​</a></h3><p>Select elements from two vectors based on a boolean mask:</p><div class="language-rust"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Conceptual usage (internal codegen)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// result[i] = mask[i] ? if_true[i] : if_false[i]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vector_select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(mask, if_true, if_false);</span></span></code></pre></div><p><strong>LLVM IR:</strong></p><div class="language-txt"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>%result = select &lt;4 x i1&gt; %mask, &lt;4 x float&gt; %a, &lt;4 x float&gt; %b</span></span></code></pre></div><h3 id="_27-11-2-vector-comparison" tabindex="-1">27.11.2 Vector Comparison <a class="header-anchor" href="#_27-11-2-vector-comparison" aria-label="Permalink to “27.11.2 Vector Comparison”">​</a></h3><p>Element-wise comparison returning a boolean mask:</p><div class="language-rust"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Supported comparisons</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> eq_mask </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b;   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Equal</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ne_mask </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b;   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Not equal</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lt_mask </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b;    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Less than</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> le_mask </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b;   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Less or equal</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gt_mask </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b;    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Greater than</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ge_mask </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b;   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Greater or equal</span></span></code></pre></div><p><strong>LLVM IR:</strong></p><div class="language-txt"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>; Float comparison</span></span>
<span class="line"><span>%mask = fcmp oeq &lt;4 x float&gt; %a, %b</span></span>
<span class="line"><span></span></span>
<span class="line"><span>; Integer comparison</span></span>
<span class="line"><span>%mask = icmp slt &lt;4 x i32&gt; %a, %b</span></span></code></pre></div><h3 id="_27-11-3-mask-reduction" tabindex="-1">27.11.3 Mask Reduction <a class="header-anchor" href="#_27-11-3-mask-reduction" aria-label="Permalink to “27.11.3 Mask Reduction”">​</a></h3><p>Reduce boolean vectors to single boolean:</p><table tabindex="0"><thead><tr><th>Function</th><th>Description</th><th>LLVM Intrinsic</th></tr></thead><tbody><tr><td><code>all(mask)</code></td><td>True if all elements true</td><td><code>llvm.vector.reduce.and</code></td></tr><tr><td><code>any(mask)</code></td><td>True if any element true</td><td><code>llvm.vector.reduce.or</code></td></tr></tbody></table><p><strong>Use Case:</strong></p><div class="language-rust"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mask </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b;           </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// [true, false, false, false]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> has_greater </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(mask);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// true</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> all_greater </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> all</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(mask);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// false</span></span></code></pre></div><h3 id="_27-11-4-implementation" tabindex="-1">27.11.4 Implementation <a class="header-anchor" href="#_27-11-4-implementation" aria-label="Permalink to “27.11.4 Implementation”">​</a></h3><table tabindex="0"><thead><tr><th>Function</th><th>File</th><th>Description</th></tr></thead><tbody><tr><td><code>compile_vector_select</code></td><td><code>vector_ops.rs</code></td><td>Blend two vectors based on mask</td></tr><tr><td><code>compile_vector_reduce_and</code></td><td><code>vector_ops.rs</code></td><td>All elements true check</td></tr><tr><td><code>compile_vector_reduce_or</code></td><td><code>vector_ops.rs</code></td><td>Any element true check</td></tr><tr><td><code>compile_vector_compare</code></td><td><code>vector_ops.rs</code></td><td>Element-wise comparison</td></tr></tbody></table><hr><h2 id="_27-12-future-work" tabindex="-1">27.12 Future Work <a class="header-anchor" href="#_27-12-future-work" aria-label="Permalink to “27.12 Future Work”">​</a></h2><ul><li><strong>Backward Mode AD</strong> (Reverse-mode for backpropagation) - stdlib tensor library</li><li><strong>AVX-512 Mask Registers</strong> - <code>kmov</code>, <code>kand</code>, <code>kor</code> instructions</li><li><strong>Runtime profiling</strong> for dynamic CPU/GPU dispatch</li><li><strong>Tensor types</strong> with compile-time shape inference</li></ul>`,117)])])}const E=i(e,[["render",h]]);export{g as __pageData,E as default};
